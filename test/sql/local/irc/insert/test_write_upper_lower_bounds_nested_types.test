# name: test/sql/local/irc/insert/test_write_upper_lower_bounds_nested_types.test
# group: [insert]

require-env ICEBERG_SERVER_AVAILABLE

require avro

require parquet

require iceberg

require httpfs

require icu

# Do not ignore 'HTTP' error messages!
set ignore_error_messages

statement ok
set enable_logging=true

statement ok
set logging_level='debug'

statement ok
SET TimeZone = 'UTC';

statement ok
CREATE SECRET (
    TYPE S3,
    KEY_ID 'admin',
    SECRET 'password',
    ENDPOINT '127.0.0.1:9000',
    URL_STYLE 'path',
    USE_SSL 0
);

statement ok
ATTACH '' AS my_datalake (
    TYPE ICEBERG,
    CLIENT_ID 'admin',
    CLIENT_SECRET 'password',
    ENDPOINT 'http://127.0.0.1:8181'
);

statement ok
drop table if exists my_datalake.default.bounds_nested_types;

statement ok
create table my_datalake.default.bounds_nested_types (
date_array DATE[],
timestamp_array TIMESTAMP[],
timestamptz_array TIMESTAMPTZ[]
);

statement error
insert into my_datalake.default.bounds_nested_types values
(
    [DATE 'infinity'],
    [TIMESTAMP 'infinity'],
    [TIMESTAMPTZ 'infinity'],
);
----
<REGEX>:.*Cannot write infinity.*


statement ok
insert into my_datalake.default.bounds_nested_types values
(
    [DATE '1990-01-01'],
    [TIMESTAMP '1990-01-01 00:00:00'],
    [TIMESTAMPTZ '1990-01-01 00:00:00'],
);


query III
select column_name, upper_bound, lower_bound from iceberg_column_stats(my_datalake.default.bounds_nested_types) order by column_name;
----
date_array	NULL	NULL
element	1990-01-01 00:00:00	1990-01-01 00:00:00
element	1989-12-31 23:00:00+00	1989-12-31 23:00:00+00
element	1990-01-01	1990-01-01
timestamp_array	NULL	NULL
timestamptz_array	NULL	NULL

statement ok
create table my_datalake.default.duckdb_nested_types (
 id INT,
 name VARCHAR,
 address STRUCT(
     street VARCHAR,
     city VARCHAR,
     zip VARCHAR
 ),
 phone_numbers VARCHAR[],
 metadata MAP(VARCHAR, VARCHAR)
);

statement ok
INSERT INTO my_datalake.default.duckdb_nested_types VALUES (
    1,
    'Alice',
    {'street': '123 Main St', 'city': 'Metropolis', 'zip': '12345'},
    ['123-456-7890', '987-654-3210'],
    MAP(['age', 'membership'], ['30', 'gold'])
);

query IIII
SELECT * FROM my_datalake.default.duckdb_nested_types;
----
1	Alice	{'street': 123 Main St, 'city': Metropolis, 'zip': 12345}	[123-456-7890, 987-654-3210]	{age=30, membership=gold}

query IIII
select column_name,column_type, upper_bound, lower_bound from iceberg_column_stats(my_datalake.default.duckdb_nested_types) order by column_name;
----
address	STRUCT(street VARCHAR, city VARCHAR, zip VARCHAR)	NULL	NULL
city	VARCHAR	Metropolis	Metropolis
element	VARCHAR	987-654-3210	123-456-7890
id	INTEGER	1	1
key	VARCHAR	membership	age
metadata	MAP(VARCHAR, VARCHAR)	NULL	NULL
name	VARCHAR	Alice	Alice
phone_numbers	VARCHAR[]	NULL	NULL
street	VARCHAR	123 Main St	123 Main St
value	VARCHAR	gold	30
zip	VARCHAR	12345	1234