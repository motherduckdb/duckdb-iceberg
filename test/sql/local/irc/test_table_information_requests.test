# name: test/sql/local/irc/test_table_information_requests.test
# description: test integration with iceberg catalog read
# group: [irc]

require-env ICEBERG_SERVER_AVAILABLE

require avro

require parquet

require iceberg

require httpfs

# Do not ignore 'HTTP' error messages!
set ignore_error_messages

statement ok
set enable_logging=true

statement ok
set logging_level='debug';

statement ok
CALL enable_logging('HTTP');

statement ok
CREATE SECRET (
    TYPE S3,
    KEY_ID 'admin',
    SECRET 'password',
    ENDPOINT '127.0.0.1:9000',
    URL_STYLE 'path',
    USE_SSL 0
);


statement ok
ATTACH '' AS my_datalake (
    TYPE ICEBERG,
    CLIENT_ID 'admin',
    CLIENT_SECRET 'password',
    ENDPOINT 'http://127.0.0.1:8181'
);

query I
select count(*) > 10 from (show all tables);
----
1

# 1 call for oath, 1 call for config
# 1 call to list namespaces
# 1 call to list tables in default
# 1 call to list tables in level1 namespace (no recursive namespace calls)
query I
select count(*) from duckdb_logs_parsed('HTTP');
----
5

statement ok
call truncate_duckdb_logs();

query II
select column_name, column_type from (describe my_datalake.default.supplier);
----
s_suppkey	BIGINT
s_name	VARCHAR
s_address	VARCHAR
s_nationkey	INTEGER
s_phone	VARCHAR
s_acctbal	DECIMAL(15,2)
s_comment	VARCHAR

# schema default is saved between queries
# one request to verify table default.supplier
# another request to the table information endpoint
# FIXME: apparantly there is also a request to an avro file
query I
select count(*) from duckdb_logs_parsed('HTTP');
----
3

statement ok
begin;

query I
select count(*) > 30 from (show all tables);
----
1

query I
select distinct(s_nationkey) from my_datalake.default.supplier order by all limit 5;
----
0
1
2
3
4

statement ok
commit;

# 3 calls from above
# 1 call to verify supplier
# 1 call to GetTableInformationEndpoint for supplier
# 1 call to the manifest list
# 2 calls to read parquet files
query I
select count(*) from duckdb_logs_parsed('HTTP');
----
8