# name: test/sql/local/iceberg_scans/iceberg_column_stats.test
# description: test iceberg metadata function
# group: [iceberg_scans]

# Before we load the extension, this will fail
statement error
SELECT * FROM ICEBERG_COLUMN_STATS('__WORKING_DIRECTORY__/data/persistent/hive_partitioned_table');
----
Error

require avro

require parquet

require iceberg

query IIIIIIIIIII
SELECT * FROM ICEBERG_COLUMN_STATS('__WORKING_DIRECTORY__/data/persistent/hive_partitioned_table', ALLOW_MOVED_PATHS=TRUE);
----
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-03/event_type=view/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00001.parquet	event_type	VARCHAR	view	view	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-03/event_type=view/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00001.parquet	user_id	BIGINT	13579	13579	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-03/event_type=view/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00001.parquet	event_date	DATE	2024-01-03	2024-01-03	36	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-03/event_type=click/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00002.parquet	event_type	VARCHAR	click	click	41	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-03/event_type=click/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00002.parquet	user_id	BIGINT	24680	24680	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-03/event_type=click/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00002.parquet	event_date	DATE	2024-01-03	2024-01-03	36	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-04/event_type=purchase/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00003.parquet	event_type	VARCHAR	purchase	purchase	43	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-04/event_type=purchase/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00003.parquet	user_id	BIGINT	97531	97531	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-04/event_type=purchase/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00003.parquet	event_date	DATE	2024-01-04	2024-01-04	36	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-04/event_type=view/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00004.parquet	event_type	VARCHAR	view	view	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-04/event_type=view/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00004.parquet	user_id	BIGINT	86420	86420	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-04/event_type=view/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00004.parquet	event_date	DATE	2024-01-04	2024-01-04	36	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-02/00000-3-249d8105-f013-47e6-8600-a855387633e5-00002.parquet	event_type	VARCHAR	purchase	purchase	43	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-02/00000-3-249d8105-f013-47e6-8600-a855387633e5-00002.parquet	user_id	BIGINT	67890	67890	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-02/00000-3-249d8105-f013-47e6-8600-a855387633e5-00002.parquet	event_date	DATE	2024-01-02	2024-01-02	36	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-01/00000-3-249d8105-f013-47e6-8600-a855387633e5-00001.parquet	event_type	VARCHAR	click	click	41	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-01/00000-3-249d8105-f013-47e6-8600-a855387633e5-00001.parquet	user_id	BIGINT	12345	12345	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-01/00000-3-249d8105-f013-47e6-8600-a855387633e5-00001.parquet	event_date	DATE	2024-01-01	2024-01-01	36	1	0	NULL

query IIIIIIIIIII
SELECT * FROM ICEBERG_COLUMN_STATS('__WORKING_DIRECTORY__/data/persistent/hive_partitioned_table', ALLOW_MOVED_PATHS=TRUE, version='1');
----

query IIIIIIIIIII
SELECT * FROM ICEBERG_COLUMN_STATS('__WORKING_DIRECTORY__/data/persistent/hive_partitioned_table', ALLOW_MOVED_PATHS=TRUE, version_name_format='v%s%s.metadata.json');
----
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-03/event_type=view/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00001.parquet	event_type	VARCHAR	view	view	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-03/event_type=view/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00001.parquet	user_id	BIGINT	13579	13579	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-03/event_type=view/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00001.parquet	event_date	DATE	2024-01-03	2024-01-03	36	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-03/event_type=click/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00002.parquet	event_type	VARCHAR	click	click	41	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-03/event_type=click/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00002.parquet	user_id	BIGINT	24680	24680	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-03/event_type=click/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00002.parquet	event_date	DATE	2024-01-03	2024-01-03	36	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-04/event_type=purchase/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00003.parquet	event_type	VARCHAR	purchase	purchase	43	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-04/event_type=purchase/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00003.parquet	user_id	BIGINT	97531	97531	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-04/event_type=purchase/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00003.parquet	event_date	DATE	2024-01-04	2024-01-04	36	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-04/event_type=view/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00004.parquet	event_type	VARCHAR	view	view	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-04/event_type=view/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00004.parquet	user_id	BIGINT	86420	86420	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-04/event_type=view/00000-8-c8ef1f50-38e5-4f6c-bc66-8b6410198355-00004.parquet	event_date	DATE	2024-01-04	2024-01-04	36	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-02/00000-3-249d8105-f013-47e6-8600-a855387633e5-00002.parquet	event_type	VARCHAR	purchase	purchase	43	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-02/00000-3-249d8105-f013-47e6-8600-a855387633e5-00002.parquet	user_id	BIGINT	67890	67890	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-02/00000-3-249d8105-f013-47e6-8600-a855387633e5-00002.parquet	event_date	DATE	2024-01-02	2024-01-02	36	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-01/00000-3-249d8105-f013-47e6-8600-a855387633e5-00001.parquet	event_type	VARCHAR	click	click	41	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-01/00000-3-249d8105-f013-47e6-8600-a855387633e5-00001.parquet	user_id	BIGINT	12345	12345	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-01/00000-3-249d8105-f013-47e6-8600-a855387633e5-00001.parquet	event_date	DATE	2024-01-01	2024-01-01	36	1	0	NULL

query IIIIIIIIIII
SELECT * FROM ICEBERG_COLUMN_STATS('__WORKING_DIRECTORY__/data/persistent/hive_partitioned_table', ALLOW_MOVED_PATHS=TRUE, version='2', version_name_format='v%s%s.metadata.json');
----
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-02/00000-3-249d8105-f013-47e6-8600-a855387633e5-00002.parquet	event_type	VARCHAR	purchase	purchase	43	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-02/00000-3-249d8105-f013-47e6-8600-a855387633e5-00002.parquet	user_id	BIGINT	67890	67890	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-02/00000-3-249d8105-f013-47e6-8600-a855387633e5-00002.parquet	event_date	DATE	2024-01-02	2024-01-02	36	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-01/00000-3-249d8105-f013-47e6-8600-a855387633e5-00001.parquet	event_type	VARCHAR	click	click	41	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-01/00000-3-249d8105-f013-47e6-8600-a855387633e5-00001.parquet	user_id	BIGINT	12345	12345	40	1	0	NULL
ADDED	EXISTING	data/persistent/hive_partitioned_table/data/event_date=2024-01-01/00000-3-249d8105-f013-47e6-8600-a855387633e5-00001.parquet	event_date	DATE	2024-01-01	2024-01-01	36	1	0	NULL

statement error
SELECT * FROM ICEBERG_COLUMN_STATS('__WORKING_DIRECTORY__/data/persistent/hive_partitioned_table_nonexistent');
----
Invalid Configuration Error: Failed to read iceberg table. No version was provided and no version-hint could be found,
